#!/usr/bin/env bash

# Shortcut for `nix shell nixpkgs#$1`, plus some niceties.

if [ -z "$1" ]; then echo "You must specify a package"; exit 1; fi

nixargs=()
case "$1" in
    -l)
        # Use the latest version of nixpkgs
        shift
        nixargs+=("nixpkgs#$1")
        name="$1"
        ;;
    -b)
        # Use the branch/rev of nixpkgs specified
        # (e.g. `get -b master discord`)
        shift
        flakeref="github:NixOS/nixpkgs/$1"
        shift
        nixargs+=("$flakeref#$1")
        name="$flakeref"
        ;;
    -E)
        # use an expr
        shift
        expr="$1"
        shift
        nixargs+=(--impure --expr "with import <nixpkgs> {}; $expr")
        name="$SHLVL.expr"
        ;;
    *)
        if [[ "$1" == *"#"* ]]; then
            # it's a specific flake
            nixargs+=("$1")
            name="$1"
        else
            # I put `nixpkgs` as the nixpkgs rev the system was built from in $NIX_PATH.
            # This makes sure I don't have to download nixpkgs *every* *single* *time*.
            nixargs+=("$(nix eval --impure --expr '<nixpkgs>')#$1")
            name="$1"
        fi
        ;;
esac

if [ -z "$GOTTEN_NIX_PKGS" ]; then
    export GOTTEN_NIX_PKGS="$name"
else
    export GOTTEN_NIX_PKGS="$GOTTEN_NIX_PKGS, $name"
fi

args=()
args+=("--impure") # https://discourse.nixos.org/t/nix-run-does-not-install-unfree-packages-nixpkgs-allow-unfree-doesnt-seem-to-help/12039
if [ "$#" -gt 1 ]; then
    shift
    args+=("--command" "$0" "$@")
fi

exec nix shell "${nixargs[@]}" "${args[@]}"
