#!/usr/bin/env bash

# Shortcut for `nix shell nixpkgs#$1`, plus some niceties.

if [ -z "$1" ]; then echo "You must specify a package"; exit 1; fi

nixargs=()
while [ -z "$done" ]; do
    case "$1" in
        -l)
            # Use the latest version of nixpkgs
            shift
            nixargs+=("nixpkgs#$1")
            name="$1"
            done=1
            ;;
        -b)
            # Use the branch/rev of nixpkgs specified
            # (e.g. `get -b master discord`)
            shift
            branch="$1"
            shift
            ;;
        -E)
            # use an expr
            shift
            expr="$1"
            shift
            if [ -z "$branch" ]; then
                nixpkgs="<nixpkgs>"
                name="$SHLVL.expr"
            else
                nixpkgs="(builtins.getFlake \"github:NixOS/nixpkgs/$branch\")"
                name="$branch/$SHLVL.expr"
            fi
            nixargs+=(--impure --expr "with import $nixpkgs {}; $expr")
            done=1
            ;;
        *)
            if [[ "$1" == *"#"* || "$1" == *":"* ]]; then
                # it's a specific flake
                nixargs+=("$1")
                name="$1"
            else
                if [ -z "$branch" ]; then
                    # I put `nixpkgs` as the nixpkgs rev the system was built from in $NIX_PATH.
                    # This makes sure I don't have to download nixpkgs *every* *single* *time*.
                    nixpkgs="$(nix eval --impure --expr '<nixpkgs>')"
                    name="$1"
                else
                    nixpkgs="github:NixOS/nixpkgs/$branch"
                    name="$branch/$1"
                fi
                nixargs+=("$nixpkgs#$1")
            fi
            done=1
            ;;
    esac
done

if [ -z "$GOTTEN_NIX_PKGS" ]; then
    export GOTTEN_NIX_PKGS="$name"
else
    export GOTTEN_NIX_PKGS="$GOTTEN_NIX_PKGS, $name"
fi

args=()
args+=("--impure") # https://discourse.nixos.org/t/nix-run-does-not-install-unfree-packages-nixpkgs-allow-unfree-doesnt-seem-to-help/12039
if [ "$#" -gt 1 ]; then
    shift
    args+=("--command" "$0" "$@")
fi

exec nix shell "${nixargs[@]}" "${args[@]}"
